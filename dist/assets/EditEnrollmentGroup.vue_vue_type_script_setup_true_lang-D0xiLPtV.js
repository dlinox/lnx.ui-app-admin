import{i as we}from"./course.services-3pIZJyxF.js";import{r as z}from"./icon.utils-D7AUVIU9.js";import{az as re,d as Q,r as y,e as M,j as se,a8 as Ee,a9 as A,aa as x,aI as ue,ab as l,ac as n,aB as ie,aA as h,b9 as he,ba as Pe,af as c,ag as X,ae as B,aG as R,_ as Z,ad as te,aH as ne,aL as ae,aY as Se,aZ as ke,ah as f}from"./index-Dga6ANj1.js";import{_ as xe}from"./Alert-DMpuOmyF.js";import{_ as Ce,a as de}from"./FormItem-DNGP1HoV.js";import{_ as ce,a as pe}from"./Col-CQISFbwN.js";import{_ as Ge}from"./Input-Cdqf_kvO.js";import{_ as me}from"./Select-zCQZwiWb.js";import{_ as Fe,a as Ne}from"./CollapseItem-BF9ydsLS.js";import{a as Ve,_ as $e}from"./ListItem-DQ5YGrPE.js";import{_ as Re}from"./Thing-BJCBE5pF.js";import{N as Te}from"./Tag-B6LobqAE.js";import{_ as ze}from"./Switch-DaLY6tbL.js";import{a as Me}from"./DataTable.types-BEg5m_To.js";import{u as Ae}from"./composables-DXkYOJGS.js";import{_ as Be}from"./Dropdown-D-rd6urP.js";const w=re(),kt=async s=>{try{return(await w.post("/enrollment/load-data-table",s)).data.data}catch{return Me()}},xt=async s=>{try{return{status:!0,data:(await w.post("/enrollment/module-store",{...s})).data.data}}catch{return{status:!1,data:null}}},De=async s=>{try{return{status:!0,data:(await w.post("/enrollment/group-store",{...s})).data.data}}catch{return{status:!1,data:null}}},Oe=async s=>{try{return{status:!0,data:(await w.post("/enrollment/group-update",{...s})).data.data}}catch{return{status:!1,data:null}}},Ue=async s=>{try{return{status:!0,data:(await w.post("/enrollment/group-reserved",{...s})).data.data}}catch{return{status:!1,data:null}}},qe=async s=>{try{return{status:!0,data:(await w.post("/enrollment/group-cancel",{...s})).data.data}}catch{return{status:!1,data:null}}},le=async s=>{try{return{status:!0,data:(await w.post("/enrollment/enabled-groups",s)).data.data}}catch{return{status:!1,data:null}}},Ct=async(s,r,d)=>{try{return(await w.post("/enrollment/student-enrollment-avaliable",{studentId:s,curriculumId:r,periodId:d})).data.data}catch{return null}},Gt=async(s,r)=>{try{return{status:!0,data:(await w.post(`/enrollment/${s}/student/${r}/curriculum`)).data.data}}catch{return{status:!1,data:[]}}},Le=async s=>{try{return{status:!0,data:(await w.get(`/enrollment/student/${s}/modules`)).data.data}}catch{return{status:!1,data:[]}}},Ft=async s=>{try{return(await w.post("/enrollment/download-enrollment-pdf",{...s},{responseType:"blob"})).data}catch{return null}},je=async s=>{try{return(await w.post("/enrollment/get-enrollment-group-payments",{...s})).data.data}catch{return[]}},Nt=async(s,r,d)=>{try{return(await w.post("/enrollment/student-enrollment-avaliable-special",{studentId:s,curriculumId:r,periodId:d})).data.data}catch{return null}},oe=()=>({id:null,studentId:null,groupId:null,payments:[],includeEnrollmentPrice:!1}),He=re(),Ke=async s=>{try{const r={...s};return r.paymentFile&&(r.paymentFile=await new Promise((a,p)=>{const v=new FileReader;v.readAsDataURL(r.paymentFile),v.onload=()=>a(v.result),v.onerror=p})),(await He.post("/payment/validate",r)).data.data}catch{return{token:null,amount:0}}},Je=()=>({studentId:null,amount:null,date:null,sequenceNumber:null,paymentTypeId:7,paymentFile:null}),We=s=>({studentId:[{required:!0,trigger:["blur","input"],message:"Obligatorio"}],amount:[{required:!0,trigger:["blur","input"],message:"Obligatorio"},{message:"Debe ser un número",trigger:["blur","input"],validator:(r,d)=>{if(d){if(!/^\d*\.?\d*$/.test(d))return new Error("Debe ser un número")}else return new Error("Obligatorio");return!0}}],date:[{required:!0,trigger:["blur","input"],message:"Obligatorio"}],sequenceNumber:[{required:!0,trigger:["blur","input"],message:"Obligatorio"},{message:s===7?"Debe tener 7 digitos":"Debe tener 6 digitos",trigger:["blur","input"],validator:(r,d)=>{if(d)if(/^\d*$/.test(d)){if(s===7&&d.length!==7)return new Error("Debe tener 7 digitos");if(s===9&&d.length!==6)return new Error("Debe tener 6 digitos")}else return new Error("Debe ser un número");else return new Error("Obligatorio");return!0}}],paymentTypeId:[{type:"number",required:!0,trigger:["blur","input"],message:"Obligatorio"}]}),Ye=Q({__name:"PaymentForm",props:{modelValue:{type:Boolean},studentId:{}},emits:["update:modelValue","success"],setup(s,{emit:r}){const d=r,a=s,p=y(!1),v=M({get:()=>a.modelValue,set:_=>d("update:modelValue",_)}),k=y(null),i=y({}),P=M(()=>We(i.value.paymentTypeId)),I=y(null),g=_=>{const t=_.target;if(!t.files||t.files.length===0){i.value.paymentFile=null;return}const b=t.files[0];if(!["image/jpeg","image/gif","image/jpg","image/png","image/webp","application/pdf"].includes(b.type)){alert("El archivo debe ser una imagen válida (JPEG, PNG, WEBP o PDF)."),i.value.paymentFile=null,t.value="";return}if(b.size>5*1024*1024){alert("El archivo no debe superar los 5 MB."),i.value.paymentFile=null,t.value="";return}i.value.paymentFile=b},m=async()=>{if(k.value&&!await k.value.validate())return;i.value.studentId=a.studentId,p.value=!0;const _=await Ke(i.value);_.token!==null&&(v.value=!1,i.value.amount=_.amount,d("success",{token:_.token,payment:i.value})),p.value=!1},S=()=>{console.log("Inicializando formulario"),i.value=Object.assign({},Je())};return se(v,_=>{_&&S()}),(_,t)=>{const b=Ee("LnxIcon"),D=he,O=xe,F=Ge,G=de,C=pe,U=me,q=X,L=ce,j=Ce,H=ie,K=ue;return x(),A(K,{show:v.value,"onUpdate:show":t[4]||(t[4]=E=>v.value=E)},{default:l(()=>[n(H,{style:{width:"500px"},title:"REGISTRAR PAGO",segmented:{content:!0,footer:!0},size:"small",role:"dialog","aria-modal":"true"},{default:l(()=>[n(O,{title:"¡Importante!",type:"default",class:"mb-4"},{icon:l(()=>[n(D,null,{default:l(()=>[n(b,{"icon-name":"information",size:"20"})]),_:1})]),default:l(()=>[t[5]||(t[5]=h(" Solo se validan pagos realizados, con un día de anticipación. "))]),_:1}),n(j,{ref_key:"formRef",ref:k,model:i.value,rules:P.value,size:"large",onKeydown:Pe(m,["enter"])},{default:l(()=>[n(L,{gutter:[16,16]},{default:l(()=>[n(C,{span:"12"},{default:l(()=>[n(G,{path:"amount",label:"Monto"},{default:l(()=>[n(F,{value:i.value.amount,"onUpdate:value":t[0]||(t[0]=E=>i.value.amount=E)},null,8,["value"])]),_:1})]),_:1}),n(C,{span:"12"},{default:l(()=>[n(G,{path:"date",label:"Fecha de pago"},{default:l(()=>[n(F,{placeholder:"",type:"date",value:i.value.date,"onUpdate:value":t[1]||(t[1]=E=>i.value.date=E)},null,8,["value"])]),_:1})]),_:1}),n(C,{span:"12"},{default:l(()=>[n(G,{path:"sequenceNumber",label:"Secuencia"},{default:l(()=>[n(F,{value:i.value.sequenceNumber,"onUpdate:value":t[2]||(t[2]=E=>i.value.sequenceNumber=E)},null,8,["value"])]),_:1})]),_:1}),n(C,{span:"12"},{default:l(()=>[n(G,{path:"paymentTypeId",label:"Metodo de pago"},{default:l(()=>[n(U,{"virtual-scroll":!1,value:i.value.paymentTypeId,"onUpdate:value":t[3]||(t[3]=E=>i.value.paymentTypeId=E),placeholder:"Metodo de pago",options:[{label:"BN - VENTANILLA",value:7},{label:"BN - PAGALO.PE",value:9}]},null,8,["value"])]),_:1})]),_:1}),n(C,{span:"24"},{default:l(()=>[n(G,{path:"paymentFile",label:"Archivo de pago"},{default:l(()=>[c("input",{class:"border w-full p-2 rounded",ref_key:"fileInput",ref:I,onChange:g,"show-button":!1,accept:"image/*,application/pdf",type:"file",placeholder:""},null,544)]),_:1})]),_:1}),n(C,{span:"24"},{default:l(()=>[n(q,{loading:p.value,secondary:"",type:"primary",onClick:m,block:"","render-icon":B(z)("money-tick")},{default:l(()=>t[6]||(t[6]=[h(" Validar Pago ")])),_:1},8,["loading","render-icon"])]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1})]),_:1},8,["show"])}}}),Ze={class:"wrapper-list-groups"},Qe={class:"table-auto w-full"},Xe={class:"px-4 py-2 flex items-center"},et={class:"ms-2"},tt={class:"text-end px-4 py-2"},nt={class:"border-b-2 border-gray-500"},at={class:"px-4 py-2 font-bold text-lg text-end"},lt={class:"px-4 py-2 font-bold text-lg text-end"},ot={key:0,class:"bg-gray-100"},rt={class:"px-4 py-2"},st={class:"px-4 py-2 font-bold text-lg text-end"},ut={class:"text-red-500 text-sm text-end text-sm"},Vt=Q({__name:"EnrollmentGroupForm",props:{modelValue:{type:Boolean},isSpecial:{type:Boolean},studentId:{},curriculumId:{},periodId:{},courseId:{},enrollmetGroup:{}},emits:["update:modelValue","success"],setup(s,{emit:r}){const d=r,a=s,p=y(!1),v=M({get:()=>a.modelValue,set:e=>d("update:modelValue",e)}),k=y(!1),i=y([]),P=y([]),I=y([]),g=y([]),m=y(0),S=y(0),_=y(0),t=y(Object.assign({},{...oe()})),b=y({moduleId:null,courseId:null}),D=async()=>{const e=await Le(a.studentId);i.value=e.data},O=async e=>{P.value=await we(e),b.value.courseId=null,e==null&&await F()},F=async()=>{let e=b.value.courseId;if(!e)e=a.courseId,await E();else{const o=await le({studentId:a.studentId,curriculumId:a.curriculumId,courseId:e,isSpecial:a.isSpecial,periodId:a.periodId});I.value=o.data,t.value.groupId=null,m.value=0,S.value=0,_.value=0,t.value.includeEnrollmentPrice=!1}},G=e=>{e?m.value=Number(_.value)+Number(S.value):m.value=Number(_.value)},C=e=>{t.value.payments.push(e.token),g.value.push({token:e.token,amount:e.payment.amount,sequenceNumber:e.payment.sequenceNumber})},U=e=>{t.value.groupId&&t.value.groupId!=e.id?(t.value.groupId=e.id,S.value=e.enrollmentPrice,_.value=e.groupPrice,a.enrollmetGroup?a.enrollmetGroup.withEnrollment?(t.value.includeEnrollmentPrice=!0,m.value=e.groupPrice+e.enrollmentPrice):(t.value.includeEnrollmentPrice=!1,m.value=e.groupPrice):(t.value.includeEnrollmentPrice=e.requireEnrollmentPrice,m.value=e.price)):t.value.groupId==e.id?(t.value.groupId=null,m.value=0,S.value=0,_.value=0,t.value.includeEnrollmentPrice=!1):(t.value.groupId=e.id,S.value=e.enrollmentPrice,_.value=e.groupPrice,a.enrollmetGroup?a.enrollmetGroup.withEnrollment?(t.value.includeEnrollmentPrice=!0,m.value=e.groupPrice+e.enrollmentPrice):(t.value.includeEnrollmentPrice=!1,m.value=e.groupPrice):(t.value.includeEnrollmentPrice=e.requireEnrollmentPrice,m.value=e.price))},q=async()=>{const e=await le({studentId:a.studentId,curriculumId:a.curriculumId,courseId:a.courseId,isSpecial:a.isSpecial,periodId:a.periodId});I.value=e.data},L=e=>{let N=g.value[e].token;g.value.splice(e,1);let V=t.value.payments.find(W=>W===N);if(!V)return;let J=t.value.payments.indexOf(V);t.value.payments.splice(J,1)},j=()=>g.value.reduce((o,N)=>o+parseFloat(N.amount),0)>=m.value?null:"El monto pagado es menor al total",H=async()=>{var e;if(t.value.studentId=a.studentId,p.value=!0,(e=a.enrollmetGroup)!=null&&e.id){(await Oe({...t.value,isSpecial:a.isSpecial,periodId:a.periodId})).status&&(d("success"),v.value=!1),p.value=!1;return}else(await De({...t.value,isSpecial:a.isSpecial,periodId:a.periodId})).status&&(d("success"),v.value=!1),p.value=!1},K=async e=>{g.value=await je({id:e})},E=async()=>{if(g.value=[],t.value=oe(),t.value.payments=[],t.value.groupId=null,m.value=0,await q(),a.enrollmetGroup){await D();let e=I.value.find(o=>o.id==a.enrollmetGroup.groupId);e&&(t.value.groupId=e.id,m.value=e.price,S.value=e.enrollmentPrice,_.value=e.groupPrice,t.value.includeEnrollmentPrice=a.enrollmetGroup.withEnrollment,b.value.courseId=null,b.value.moduleId=null,t.value.includeEnrollmentPrice||(m.value=Number(_.value))),t.value.id=a.enrollmetGroup.id,await K(a.enrollmetGroup.id),g.value.length>0&&g.value.forEach(o=>{t.value.payments.push(o.token)})}console.log("Inicializando formulario")};return se(v,e=>{e&&E()}),(e,o)=>{const N=me,V=de,J=Ne,W=Fe,T=pe,ee=Te,Y=X,_e=Re,ve=$e,ge=Ve,fe=ze,ye=ce,be=ie,Ie=ue;return x(),R(Z,null,[n(Ie,{show:v.value,"onUpdate:show":o[4]||(o[4]=u=>v.value=u)},{default:l(()=>[n(be,{style:{width:"600px"},title:e.isSpecial?"Matricula Especial":"Matricula Regular",segmented:{content:!0,footer:!0},size:"small",role:"dialog","aria-modal":"true"},{default:l(()=>[n(ye,{gutter:[16,16]},{default:l(()=>[e.enrollmetGroup?(x(),A(T,{key:0,span:"24",class:"border-b"},{default:l(()=>[n(W,null,{default:l(()=>[n(J,{title:"Cambiar curso",name:"1"},{"header-extra":l(()=>[n(ne,{"icon-name":"book",class:"text-gray-400"})]),default:l(()=>[n(V,{label:"Módulo"},{default:l(()=>[n(N,{value:b.value.moduleId,"onUpdate:value":[o[0]||(o[0]=u=>b.value.moduleId=u),O],placeholder:"Seleccionar modulo",options:i.value,"virtual-scroll":!1,clearable:"",filterable:""},null,8,["value","options"])]),_:1}),n(V,{label:"Curso"},{default:l(()=>[n(N,{value:b.value.courseId,"onUpdate:value":[o[1]||(o[1]=u=>b.value.courseId=u),F],placeholder:"Seleccionar curso",options:P.value,"virtual-scroll":!1,clearable:"",filterable:""},null,8,["value","options"])]),_:1})]),_:1})]),_:1})]),_:1})):te("",!0),n(T,{span:"24"},{default:l(()=>[c("div",Ze,[n(ge,{hoverable:"",clickable:""},{header:l(()=>{var u;return[h(" Grupos aperturados ("+f((u=I.value)!=null&&u.length?I.value.length:0)+") ",1)]}),default:l(()=>[(x(!0),R(Z,null,ae(I.value,u=>(x(),A(ve,{key:u.id,class:Se({"item-selected":t.value.groupId==u.id}),extra:u.price},{default:l(()=>[n(_e,{onClick:$=>U(u)},ke({header:l(()=>[n(ee,{bordered:!1,type:u.modality=="VIRTUAL"?"info":"success",size:"small"},{default:l(()=>[h(f(u.modality),1)]),_:2},1032,["type"]),h(" "+f(`${u.group} - S/. ${u.price}`),1)]),default:l(()=>[o[6]||(o[6]=h(" Min.: ")),c("b",null,f(u.minStudents),1),o[7]||(o[7]=h(" | Matriculados: ")),c("b",null,f(u.enrolledStudents),1),o[8]||(o[8]=h(" | Reservados: ")),c("b",null,f(u.reservedStudents),1),o[9]||(o[9]=c("br",null,null,-1)),n(ee,{bordered:!1,type:"info",size:"small"},{default:l(()=>[c("strong",null,f(u.schedules.days)+" - "+f(u.schedules.startHour)+" a "+f(u.schedules.endHour),1)]),_:2},1024)]),_:2},[t.value.groupId==u.id?{name:"header-extra",fn:l(()=>[n(Y,{circle:"",type:"warning","render-icon":B(z)("verify")},null,8,["render-icon"])]),key:"0"}:void 0]),1032,["onClick"])]),_:2},1032,["class","extra"]))),128))]),_:1})])]),_:1}),n(T,{span:"24"},{default:l(()=>[c("span",{role:"button",onClick:o[2]||(o[2]=u=>k.value=!0),class:"border border-dashed border-gray-300 p-4 rounded-sm flex items-center justify-center cursor-pointer text-gray-400 hover:bg-gray-50 font-bold hover:text-gray-500 mb-4"},[n(ne,{class:"me-3","icon-name":"money-add",size:"20"}),o[10]||(o[10]=h(" Agregar pago "))]),c("table",Qe,[c("tbody",null,[(x(!0),R(Z,null,ae(g.value,(u,$)=>(x(),R("tr",{key:$,class:"border-b border-gray-300 border-dashed px-4 py-2"},[c("td",Xe,[n(Y,{type:"error",size:"small",secondary:"",onClick:it=>L($),"render-icon":B(z)("trash")},null,8,["onClick","render-icon"]),c("i",et,f(u.sequenceNumber),1)]),c("td",tt,"S/. "+f(u.amount),1)]))),128)),c("tr",nt,[o[11]||(o[11]=c("td",{class:"px-4 py-2"},"Total importe",-1)),c("td",at," S/. "+f(g.value.reduce((u,$)=>u+parseFloat($.amount),0)),1)]),c("tr",null,[o[12]||(o[12]=c("td",{class:"px-4 py-2"},"Total a pagar",-1)),c("td",lt," S/. "+f(m.value),1)]),S.value>0?(x(),R("tr",ot,[c("td",rt,[o[13]||(o[13]=h(" ¿Incluye matrícula? ")),c("strong",null," S/. "+f(S.value),1)]),c("td",st,[n(fe,{disabled:!t.value.groupId,value:t.value.includeEnrollmentPrice,"onUpdate:value":[o[3]||(o[3]=u=>t.value.includeEnrollmentPrice=u),G]},null,8,["disabled","value"])])])):te("",!0)])]),c("div",ut,f(j()),1)]),_:1}),n(T,{span:"24"},{default:l(()=>[n(Y,{size:"large",type:"primary",onClick:H,block:"",loading:p.value},{default:l(()=>o[14]||(o[14]=[h(" Realizar Matricula ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["title"])]),_:1},8,["show"]),n(Ye,{modelValue:k.value,"onUpdate:modelValue":o[5]||(o[5]=u=>k.value=u),studentId:a.studentId,onSuccess:C},null,8,["modelValue","studentId"])],64)}}}),$t=Q({__name:"EditEnrollmentGroup",props:{item:{}},emits:["changeGroup","reserveEnrollment","cancelEnrollment","resetEnrollment"],setup(s,{emit:r}){const d=Ae(),a=r,p=s,v=async i=>{switch(i){case"change-group":a("changeGroup",p.item);break;case"reserve-enrollment":d.warning({title:"Confirmar",content:"¿Está seguro de realizar la reserva de la matrícula?",positiveText:"Reservar",negativeText:"Cancelar",closable:!1,showIcon:!1,negativeButtonProps:{secondary:!0,type:"tertiary",size:"large"},positiveButtonProps:{size:"large",type:"primary"},bordered:!0,onPositiveClick:async()=>{await Ue(p.item),a("reserveEnrollment",p.item)}});break;case"cancel-enrollment":d.warning({title:"Confirmar",content:"¿Está seguro de cancelar la matrícula?",positiveText:"Cancelar matrícula",negativeText:"Cancelar",closable:!1,showIcon:!1,negativeButtonProps:{secondary:!0,type:"tertiary",size:"large"},positiveButtonProps:{size:"large",type:"error"},onPositiveClick:async()=>{await qe(p.item),a("cancelEnrollment",p.item)}});break;case"reset-enrollment":a("resetEnrollment",p.item);break}},k=M(()=>{var i,P,I,g,m;return[{label:"Cambiar grupo",key:"change-group",disabled:((i=p.item)==null?void 0:i.enrollmentStatus)!=="MATRICULADO"},{label:"Reservar matrícula",key:"reserve-enrollment",disabled:((P=p.item)==null?void 0:P.enrollmentStatus)!=="MATRICULADO"},{label:"Cancelar matrícula",key:"cancel-enrollment",disabled:((I=p.item)==null?void 0:I.enrollmentStatus)=="CANCELADO"},{label:"Reestablecer matrícula",key:"reset-enrollment",disabled:((g=p.item)==null?void 0:g.enrollmentStatus)!=="CANCELADO"&&((m=p.item)==null?void 0:m.enrollmentStatus)!=="RESERVADO"}]});return(i,P)=>{const I=X,g=Be;return x(),A(g,{trigger:"click",options:k.value,"show-arrow":!0,onSelect:v},{default:l(()=>[n(I,{"render-icon":B(z)("magicpen")},{default:l(()=>P[0]||(P[0]=[h(" Opt. ")])),_:1},8,["render-icon"])]),_:1},8,["options"])}}});export{Ye as _,le as a,xt as b,Gt as c,$t as d,Vt as e,Ft as f,Ct as g,Nt as h,kt as i};
