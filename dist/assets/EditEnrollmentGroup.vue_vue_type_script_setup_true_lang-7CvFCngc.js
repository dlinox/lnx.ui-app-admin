import{i as we}from"./course.services-BaqRewrM.js";import{r as z}from"./icon.utils-BskQV8nf.js";import{az as re,d as Q,r as y,e as M,j as se,a8 as Ee,a9 as A,aa as x,aI as ue,ab as a,ac as n,aB as ie,aA as w,b9 as he,ba as Pe,af as c,ag as X,ae as B,aG as R,_ as Z,ad as te,aH as ne,aL as ae,aY as Se,aZ as ke,ah as f}from"./index-DJC0BDyi.js";import{_ as xe}from"./Alert-DmCNILB5.js";import{_ as Ce,a as de}from"./FormItem-hkNBqYHR.js";import{_ as ce,a as pe}from"./Col-C21edevQ.js";import{_ as Ge}from"./Input-DBFrJf3T.js";import{_ as me}from"./Select-DspmZ1pU.js";import{_ as Fe,a as Ne}from"./CollapseItem-BoZMOQO4.js";import{a as Ve,_ as $e}from"./ListItem-C4iNgzvu.js";import{_ as Re}from"./Thing-B2WvJBao.js";import{N as Te}from"./Tag-Dk2E0f9P.js";import{_ as ze}from"./Switch-BVWaAsm_.js";import{a as Me}from"./DataTable.types-BEg5m_To.js";import{u as Ae}from"./composables-Blw5S8Da.js";import{_ as Be}from"./Dropdown-BOxrGR0y.js";const I=re(),kt=async r=>{try{return(await I.post("/enrollment/load-data-table",r)).data.data}catch{return Me()}},xt=async r=>{try{return{status:!0,data:(await I.post("/enrollment/module-store",{...r})).data.data}}catch{return{status:!1,data:null}}},De=async r=>{try{return{status:!0,data:(await I.post("/enrollment/group-store",{...r})).data.data}}catch{return{status:!1,data:null}}},Oe=async r=>{try{return{status:!0,data:(await I.post("/enrollment/group-update",{...r})).data.data}}catch{return{status:!1,data:null}}},Ue=async r=>{try{return{status:!0,data:(await I.post("/enrollment/group-reserved",{...r})).data.data}}catch{return{status:!1,data:null}}},qe=async r=>{try{return{status:!0,data:(await I.post("/enrollment/group-cancel",{...r})).data.data}}catch{return{status:!1,data:null}}},le=async r=>{try{return{status:!0,data:(await I.post("/enrollment/enabled-groups",r)).data.data}}catch{return{status:!1,data:null}}},Ct=async(r,o,d)=>{try{return(await I.post("/enrollment/student-enrollment-avaliable",{studentId:r,curriculumId:o,periodId:d})).data.data}catch{return null}},Gt=async(r,o)=>{try{return{status:!0,data:(await I.post(`/enrollment/${r}/student/${o}/curriculum`)).data.data}}catch{return{status:!1,data:[]}}},Le=async r=>{try{return{status:!0,data:(await I.get(`/enrollment/student/${r}/modules`)).data.data}}catch{return{status:!1,data:[]}}},Ft=async r=>{try{return(await I.post("/enrollment/download-enrollment-pdf",{...r},{responseType:"blob"})).data}catch{return null}},je=async r=>{try{return(await I.post("/enrollment/get-enrollment-group-payments",{...r})).data.data}catch{return[]}},Nt=async(r,o,d)=>{try{return(await I.post("/enrollment/student-enrollment-avaliable-special",{studentId:r,curriculumId:o,periodId:d})).data.data}catch{return null}},oe=()=>({id:null,studentId:null,groupId:null,payments:[],includeEnrollmentPrice:!1}),He=re(),Ke=async r=>{try{const o={...r};return o.paymentFile&&(o.paymentFile=await new Promise((l,p)=>{const g=new FileReader;g.readAsDataURL(o.paymentFile),g.onload=()=>l(g.result),g.onerror=p})),(await He.post("/payment/validate",o)).data.data}catch{return{token:null,amount:0}}},Je=()=>({studentId:null,amount:null,date:null,sequenceNumber:null,paymentTypeId:7,paymentFile:null}),We=r=>({studentId:[{required:!0,trigger:["blur","input"],message:"Obligatorio"}],amount:[{required:!0,trigger:["blur","input"],message:"Obligatorio"},{message:"Debe ser un número",trigger:["blur","input"],validator:(o,d)=>{if(d){if(!/^\d*\.?\d*$/.test(d))return new Error("Debe ser un número")}else return new Error("Obligatorio");return!0}}],date:[{required:!0,trigger:["blur","input"],message:"Obligatorio"}],sequenceNumber:[{required:!0,trigger:["blur","input"],message:"Obligatorio"},{message:r===7?"Debe tener 7 digitos":"Debe tener 6 digitos",trigger:["blur","input"],validator:(o,d)=>{if(d)if(/^\d*$/.test(d)){if(r===7&&d.length!==7)return new Error("Debe tener 7 digitos");if(r===9&&d.length!==6)return new Error("Debe tener 6 digitos")}else return new Error("Debe ser un número");else return new Error("Obligatorio");return!0}}],paymentTypeId:[{type:"number",required:!0,trigger:["blur","input"],message:"Obligatorio"}]}),Ye=Q({__name:"PaymentForm",props:{modelValue:{type:Boolean},studentId:{}},emits:["update:modelValue","success"],setup(r,{emit:o}){const d=o,l=r,p=y(!1),g=M({get:()=>l.modelValue,set:_=>d("update:modelValue",_)}),S=y(null),i=y({}),h=M(()=>We(i.value.paymentTypeId)),b=y(null),v=_=>{const e=_.target;if(!e.files||e.files.length===0){i.value.paymentFile=null;return}const P=e.files[0];if(!["image/jpeg","image/gif","image/jpg","image/png","image/webp","application/pdf"].includes(P.type)){alert("El archivo debe ser una imagen válida (JPEG, PNG, WEBP o PDF)."),i.value.paymentFile=null,e.value="";return}if(P.size>5*1024*1024){alert("El archivo no debe superar los 5 MB."),i.value.paymentFile=null,e.value="";return}i.value.paymentFile=P},m=async()=>{if(S.value&&!await S.value.validate())return;i.value.studentId=l.studentId,p.value=!0;const _=await Ke(i.value);_.token!==null&&(g.value=!1,i.value.amount=_.amount,d("success",{token:_.token,payment:i.value})),p.value=!1},k=()=>{console.log("Inicializando formulario"),i.value=Object.assign({},Je())};return se(g,_=>{_&&k()}),(_,e)=>{const P=Ee("LnxIcon"),D=he,O=xe,N=Ge,G=de,C=pe,U=me,q=X,L=ce,j=Ce,H=ie,K=ue;return x(),A(K,{show:g.value,"onUpdate:show":e[4]||(e[4]=E=>g.value=E)},{default:a(()=>[n(H,{style:{width:"500px"},title:"REGISTRAR PAGO",segmented:{content:!0,footer:!0},size:"small",role:"dialog","aria-modal":"true"},{default:a(()=>[n(O,{title:"¡Importante!",type:"default",class:"mb-4"},{icon:a(()=>[n(D,null,{default:a(()=>[n(P,{"icon-name":"information",size:"20"})]),_:1})]),default:a(()=>[e[5]||(e[5]=w(" Solo se validan pagos realizados, con un día de anticipación. "))]),_:1}),n(j,{ref_key:"formRef",ref:S,model:i.value,rules:h.value,size:"large",onKeydown:Pe(m,["enter"])},{default:a(()=>[n(L,{gutter:[16,16]},{default:a(()=>[n(C,{span:"12"},{default:a(()=>[n(G,{path:"amount",label:"Monto"},{default:a(()=>[n(N,{value:i.value.amount,"onUpdate:value":e[0]||(e[0]=E=>i.value.amount=E)},null,8,["value"])]),_:1})]),_:1}),n(C,{span:"12"},{default:a(()=>[n(G,{path:"date",label:"Fecha de pago"},{default:a(()=>[n(N,{placeholder:"",type:"date",value:i.value.date,"onUpdate:value":e[1]||(e[1]=E=>i.value.date=E)},null,8,["value"])]),_:1})]),_:1}),n(C,{span:"12"},{default:a(()=>[n(G,{path:"sequenceNumber",label:"Secuencia"},{default:a(()=>[n(N,{value:i.value.sequenceNumber,"onUpdate:value":e[2]||(e[2]=E=>i.value.sequenceNumber=E)},null,8,["value"])]),_:1})]),_:1}),n(C,{span:"12"},{default:a(()=>[n(G,{path:"paymentTypeId",label:"Metodo de pago"},{default:a(()=>[n(U,{"virtual-scroll":!1,value:i.value.paymentTypeId,"onUpdate:value":e[3]||(e[3]=E=>i.value.paymentTypeId=E),placeholder:"Metodo de pago",options:[{label:"BN - VENTANILLA",value:7},{label:"BN - PAGALO.PE",value:9}]},null,8,["value"])]),_:1})]),_:1}),n(C,{span:"24"},{default:a(()=>[n(G,{path:"paymentFile",label:"Archivo de pago"},{default:a(()=>[c("input",{class:"border w-full p-2 rounded",ref_key:"fileInput",ref:b,onChange:v,"show-button":!1,accept:"image/*,application/pdf",type:"file",placeholder:""},null,544)]),_:1})]),_:1}),n(C,{span:"24"},{default:a(()=>[n(q,{loading:p.value,secondary:"",type:"primary",onClick:m,block:"","render-icon":B(z)("money-tick")},{default:a(()=>e[6]||(e[6]=[w(" Validar Pago ")])),_:1},8,["loading","render-icon"])]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1})]),_:1},8,["show"])}}}),Ze={class:"wrapper-list-groups"},Qe={class:"table-auto w-full"},Xe={class:"px-4 py-2 flex items-center"},et={class:"ms-2"},tt={class:"text-end px-4 py-2"},nt={class:"border-b-2 border-gray-500"},at={class:"px-4 py-2 font-bold text-lg text-end"},lt={class:"px-4 py-2 font-bold text-lg text-end"},ot={key:0,class:"bg-gray-100"},rt={class:"px-4 py-2"},st={class:"px-4 py-2 font-bold text-lg text-end"},ut={class:"text-red-500 text-sm text-end text-sm"},Vt=Q({__name:"EnrollmentGroupForm",props:{modelValue:{type:Boolean},isSpecial:{type:Boolean},studentId:{},curriculumId:{},periodId:{},courseId:{},enrollmetGroup:{}},emits:["update:modelValue","success"],setup(r,{emit:o}){const d=o,l=r,p=y(!1),g=M({get:()=>l.modelValue,set:t=>d("update:modelValue",t)}),S=y(!1),i=y([]),h=y([]),b=y([]),v=y([]),m=y(0),k=y(0),_=y(0),e=y(Object.assign({},{...oe()})),P=y({moduleId:null,courseId:null}),D=async()=>{const t=await Le(l.studentId);i.value=t.data},O=async t=>{h.value=await we(t),P.value.courseId=null},N=async()=>{const t=await le({studentId:l.studentId,curriculumId:l.curriculumId,courseId:P.value.courseId,isSpecial:l.isSpecial,periodId:l.periodId});b.value=t.data},G=t=>{t?m.value=Number(_.value)+Number(k.value):m.value=Number(_.value)},C=t=>{e.value.payments.push(t.token),v.value.push({token:t.token,amount:t.payment.amount,sequenceNumber:t.payment.sequenceNumber})},U=t=>{e.value.groupId&&e.value.groupId!=t.id?(e.value.groupId=t.id,k.value=t.enrollmentPrice,_.value=t.groupPrice,l.enrollmetGroup?l.enrollmetGroup.withEnrollment?(e.value.includeEnrollmentPrice=!0,m.value=t.groupPrice+t.enrollmentPrice):(e.value.includeEnrollmentPrice=!1,m.value=t.groupPrice):(e.value.includeEnrollmentPrice=t.requireEnrollmentPrice,m.value=t.price)):e.value.groupId==t.id?(e.value.groupId=null,m.value=0,k.value=0,_.value=0,e.value.includeEnrollmentPrice=!1):(e.value.groupId=t.id,k.value=t.enrollmentPrice,_.value=t.groupPrice,l.enrollmetGroup?l.enrollmetGroup.withEnrollment?(e.value.includeEnrollmentPrice=!0,m.value=t.groupPrice+t.enrollmentPrice):(e.value.includeEnrollmentPrice=!1,m.value=t.groupPrice):(e.value.includeEnrollmentPrice=t.requireEnrollmentPrice,m.value=t.price))},q=async()=>{const t=await le({studentId:l.studentId,curriculumId:l.curriculumId,courseId:l.courseId,isSpecial:l.isSpecial,periodId:l.periodId});b.value=t.data},L=t=>{let F=v.value[t].token;v.value.splice(t,1);let V=e.value.payments.find(W=>W===F);if(!V)return;let J=e.value.payments.indexOf(V);e.value.payments.splice(J,1)},j=()=>v.value.reduce((s,F)=>s+parseFloat(F.amount),0)>=m.value?null:"El monto pagado es menor al total",H=async()=>{var t;if(e.value.studentId=l.studentId,p.value=!0,(t=l.enrollmetGroup)!=null&&t.id){(await Oe({...e.value,isSpecial:l.isSpecial,periodId:l.periodId})).status&&(d("success"),g.value=!1),p.value=!1;return}else(await De({...e.value,isSpecial:l.isSpecial,periodId:l.periodId})).status&&(d("success"),g.value=!1),p.value=!1},K=async t=>{v.value=await je({id:t})},E=async()=>{if(v.value=[],e.value=oe(),e.value.payments=[],e.value.groupId=null,m.value=0,await q(),l.enrollmetGroup){await D();let t=b.value.find(s=>s.id==l.enrollmetGroup.groupId);t&&(e.value.groupId=t.id,m.value=t.price,k.value=t.enrollmentPrice,_.value=t.groupPrice,e.value.includeEnrollmentPrice=l.enrollmetGroup.withEnrollment,e.value.includeEnrollmentPrice||(m.value=Number(_.value))),e.value.id=l.enrollmetGroup.id,await K(l.enrollmetGroup.id),v.value.length>0&&v.value.forEach(s=>{e.value.payments.push(s.token)})}console.log("Inicializando formulario")};return se(g,t=>{t&&E()}),(t,s)=>{const F=me,V=de,J=Ne,W=Fe,T=pe,ee=Te,Y=X,_e=Re,ge=$e,ve=Ve,fe=ze,ye=ce,be=ie,Ie=ue;return x(),R(Z,null,[n(Ie,{show:g.value,"onUpdate:show":s[3]||(s[3]=u=>g.value=u)},{default:a(()=>[n(be,{style:{width:"600px"},title:t.isSpecial?"Matricula Especial":"Matricula Regular",segmented:{content:!0,footer:!0},size:"small",role:"dialog","aria-modal":"true"},{default:a(()=>[n(ye,{gutter:[16,16]},{default:a(()=>[t.enrollmetGroup?(x(),A(T,{key:0,span:"24",class:"border-b"},{default:a(()=>[n(W,null,{default:a(()=>[n(J,{title:"Cambiar curso",name:"1"},{"header-extra":a(()=>[n(ne,{"icon-name":"book",class:"text-gray-400"})]),default:a(()=>[n(V,{label:"Módulo"},{default:a(()=>[n(F,{placeholder:"Seleccionar modulo",options:i.value,"virtual-scroll":!1,clearable:"",filterable:"","onUpdate:value":O},null,8,["options"])]),_:1}),n(V,{label:"Curso"},{default:a(()=>[n(F,{value:P.value.courseId,"onUpdate:value":[s[0]||(s[0]=u=>P.value.courseId=u),N],placeholder:"Seleccionar curso",options:h.value,"virtual-scroll":!1,clearable:"",filterable:""},null,8,["value","options"])]),_:1})]),_:1})]),_:1})]),_:1})):te("",!0),n(T,{span:"24"},{default:a(()=>[c("div",Ze,[n(ve,{hoverable:"",clickable:""},{header:a(()=>{var u;return[w(" Grupos aperturados ("+f((u=b.value)!=null&&u.length?b.value.length:0)+") ",1)]}),default:a(()=>[(x(!0),R(Z,null,ae(b.value,u=>(x(),A(ge,{key:u.id,class:Se({"item-selected":e.value.groupId==u.id}),extra:u.price},{default:a(()=>[n(_e,{onClick:$=>U(u)},ke({header:a(()=>[n(ee,{bordered:!1,type:u.modality=="VIRTUAL"?"info":"success",size:"small"},{default:a(()=>[w(f(u.modality),1)]),_:2},1032,["type"]),w(" "+f(`${u.group} - S/. ${u.price}`),1)]),default:a(()=>[s[5]||(s[5]=w(" Min.: ")),c("b",null,f(u.minStudents),1),s[6]||(s[6]=w(" | Matriculados: ")),c("b",null,f(u.enrolledStudents),1),s[7]||(s[7]=w(" | Reservados: ")),c("b",null,f(u.reservedStudents),1),s[8]||(s[8]=c("br",null,null,-1)),n(ee,{bordered:!1,type:"info",size:"small"},{default:a(()=>[c("strong",null,f(u.schedules.days)+" - "+f(u.schedules.startHour)+" a "+f(u.schedules.endHour),1)]),_:2},1024)]),_:2},[e.value.groupId==u.id?{name:"header-extra",fn:a(()=>[n(Y,{circle:"",type:"warning","render-icon":B(z)("verify")},null,8,["render-icon"])]),key:"0"}:void 0]),1032,["onClick"])]),_:2},1032,["class","extra"]))),128))]),_:1})])]),_:1}),n(T,{span:"24"},{default:a(()=>[c("span",{role:"button",onClick:s[1]||(s[1]=u=>S.value=!0),class:"border border-dashed border-gray-300 p-4 rounded-sm flex items-center justify-center cursor-pointer text-gray-400 hover:bg-gray-50 font-bold hover:text-gray-500 mb-4"},[n(ne,{class:"me-3","icon-name":"money-add",size:"20"}),s[9]||(s[9]=w(" Agregar pago "))]),c("table",Qe,[c("tbody",null,[(x(!0),R(Z,null,ae(v.value,(u,$)=>(x(),R("tr",{key:$,class:"border-b border-gray-300 border-dashed px-4 py-2"},[c("td",Xe,[n(Y,{type:"error",size:"small",secondary:"",onClick:it=>L($),"render-icon":B(z)("trash")},null,8,["onClick","render-icon"]),c("i",et,f(u.sequenceNumber),1)]),c("td",tt,"S/. "+f(u.amount),1)]))),128)),c("tr",nt,[s[10]||(s[10]=c("td",{class:"px-4 py-2"},"Total importe",-1)),c("td",at," S/. "+f(v.value.reduce((u,$)=>u+parseFloat($.amount),0)),1)]),c("tr",null,[s[11]||(s[11]=c("td",{class:"px-4 py-2"},"Total a pagar",-1)),c("td",lt," S/. "+f(m.value),1)]),k.value>0?(x(),R("tr",ot,[c("td",rt,[s[12]||(s[12]=w(" ¿Incluye matrícula? ")),c("strong",null," S/. "+f(k.value),1)]),c("td",st,[n(fe,{disabled:!e.value.groupId,value:e.value.includeEnrollmentPrice,"onUpdate:value":[s[2]||(s[2]=u=>e.value.includeEnrollmentPrice=u),G]},null,8,["disabled","value"])])])):te("",!0)])]),c("div",ut,f(j()),1)]),_:1}),n(T,{span:"24"},{default:a(()=>[n(Y,{size:"large",type:"primary",onClick:H,block:"",loading:p.value},{default:a(()=>s[13]||(s[13]=[w(" Realizar Matricula ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["title"])]),_:1},8,["show"]),n(Ye,{modelValue:S.value,"onUpdate:modelValue":s[4]||(s[4]=u=>S.value=u),studentId:l.studentId,onSuccess:C},null,8,["modelValue","studentId"])],64)}}}),$t=Q({__name:"EditEnrollmentGroup",props:{item:{}},emits:["changeGroup","reserveEnrollment","cancelEnrollment","resetEnrollment"],setup(r,{emit:o}){const d=Ae(),l=o,p=r,g=async i=>{switch(i){case"change-group":l("changeGroup",p.item);break;case"reserve-enrollment":d.warning({title:"Confirmar",content:"¿Está seguro de realizar la reserva de la matrícula?",positiveText:"Reservar",negativeText:"Cancelar",closable:!1,showIcon:!1,negativeButtonProps:{secondary:!0,type:"tertiary",size:"large"},positiveButtonProps:{size:"large",type:"primary"},bordered:!0,onPositiveClick:async()=>{await Ue(p.item),l("reserveEnrollment",p.item)}});break;case"cancel-enrollment":d.warning({title:"Confirmar",content:"¿Está seguro de cancelar la matrícula?",positiveText:"Cancelar matrícula",negativeText:"Cancelar",closable:!1,showIcon:!1,negativeButtonProps:{secondary:!0,type:"tertiary",size:"large"},positiveButtonProps:{size:"large",type:"error"},onPositiveClick:async()=>{await qe(p.item),l("cancelEnrollment",p.item)}});break;case"reset-enrollment":l("resetEnrollment",p.item);break}},S=M(()=>{var i,h,b,v,m;return[{label:"Cambiar grupo",key:"change-group",disabled:((i=p.item)==null?void 0:i.enrollmentStatus)!=="MATRICULADO"},{label:"Reservar matrícula",key:"reserve-enrollment",disabled:((h=p.item)==null?void 0:h.enrollmentStatus)!=="MATRICULADO"},{label:"Cancelar matrícula",key:"cancel-enrollment",disabled:((b=p.item)==null?void 0:b.enrollmentStatus)=="CANCELADO"},{label:"Reestablecer matrícula",key:"reset-enrollment",disabled:((v=p.item)==null?void 0:v.enrollmentStatus)!=="CANCELADO"&&((m=p.item)==null?void 0:m.enrollmentStatus)!=="RESERVADO"}]});return(i,h)=>{const b=X,v=Be;return x(),A(v,{trigger:"click",options:S.value,"show-arrow":!0,onSelect:g},{default:a(()=>[n(b,{"render-icon":B(z)("magicpen")},{default:a(()=>h[0]||(h[0]=[w(" Opt. ")])),_:1},8,["render-icon"])]),_:1},8,["options"])}}});export{Ye as _,le as a,xt as b,Gt as c,$t as d,Vt as e,Ft as f,Ct as g,Nt as h,kt as i};
